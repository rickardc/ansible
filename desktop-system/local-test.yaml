---
# Run with ansible-playbook playbooks/local-test.yaml --connection=local
- name: Local install miniconda, vscode, docker
  hosts: 127.0.0.1
  gather_facts: true

  tasks:

    # Check if Docker is installed
    - name: Check if Docker is installed
      ansible.builtin.command: "rpm -q docker-ce"
      register: docker_installed
      ignore_errors: true
      become: true

    # Install Docker if it's not already installed
    - name: Install Docker
      block:
        - name: Install dnf-plugins-core
          ansible.builtin.dnf:
            name: dnf-plugins-core
            state: present
          become: true

        - name: Add Docker repository
          ansible.builtin.command: "sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo"
          become: true

        - name: Install Docker
          ansible.builtin.dnf:
            name: docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin
            state: present
          become: true
      when: docker_installed.rc != 0

    # Display message if Docker is already installed
    - name: Display message if Docker is already installed
      ansible.builtin.debug:
        msg: "Docker is already installed"
      when: docker_installed.rc == 0

    # Check if Docker Desktop is installed
    - name: Check if Docker Desktop is installed
      stat:
        path: "/usr/local/bin/com.docker.cli"
      register: docker_desktop_installed
      become: true

    # Install Docker Desktop if it's not already installed
    - name: Install Docker Desktop
      block:
        - name: Set up Docker's package repository
          shell: "sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo"
          become: true

        - name: Download Docker Desktop RPM package
          get_url:
            url: "https://desktop.docker.com/linux/main/amd64/145265/docker-desktop-4.29.0-x86_64.rpm"
            dest: "/tmp/docker-desktop.rpm"
          become: true
          vars:
            docker_desktop_version: "latest"  # Specify version if needed
            docker_desktop_arch: "x86_64"     # Specify architecture if needed

        - name: Install Docker Desktop
          ansible.builtin.dnf:
            name: "/tmp/docker-desktop.rpm"
            state: present
            disable_gpg_check: yes  # Disable GPG signature check
          become: true

    # Display message if Docker Desktop is already installed
    - name: Display message if Docker Desktop is already installed
      debug:
        msg: "Docker Desktop is already installed"
      when: docker_desktop_installed.stat.exists == true
